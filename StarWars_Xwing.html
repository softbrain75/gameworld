import React, { useState, useEffect, useRef } from 'react';
import { Target, Trophy, Zap, Shield, Star } from 'lucide-react';

const XWingGame = () => {
  const canvasRef = useRef(null);
  const [gameState, setGameState] = useState('menu');
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(0);
  const [kills, setKills] = useState(0);
  const [health, setHealth] = useState(100);
  const [enemies, setEnemies] = useState([]);
  const [lasers, setLasers] = useState([]);
  const [explosions, setExplosions] = useState([]);
  const [targetLocked, setTargetLocked] = useState(null);
  const [crosshairPos, setCrosshairPos] = useState({ x: 400, y: 300 }); // 조준선 위치

  const CANVAS_WIDTH = 800;
  const CANVAS_HEIGHT = 600;
  const CROSSHAIR_SIZE = 80;

  useEffect(() => {
    const saved = localStorage.getItem('xwingHighScore');
    if (saved) setHighScore(parseInt(saved));
  }, []);

  useEffect(() => {
    if (gameState !== 'playing') return;

    // Spawn TIE Fighters
    const spawnInterval = setInterval(() => {
      const size = 60 + Math.random() * 40; // 크게!
      setEnemies(prev => [...prev, {
        id: Date.now() + Math.random(),
        x: Math.random() * (CANVAS_WIDTH - size) + size / 2,
        y: -size,
        size,
        speed: 1 + Math.random() * 2,
        health: 3,
        maxHealth: 3,
        vx: (Math.random() - 0.5) * 3 // 좌우 움직임
      }]);
    }, 2000);

    return () => clearInterval(spawnInterval);
  }, [gameState]);

  useEffect(() => {
    if (health <= 0 && gameState === 'playing') {
      setGameState('gameover');
      if (score > highScore) {
        setHighScore(score);
        localStorage.setItem('xwingHighScore', score.toString());
      }
    }
  }, [health]);

  useEffect(() => {
    if (gameState !== 'playing') return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    const time = { value: 0 };

    const gameLoop = () => {
      time.value += 0.02;
      
      ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

      // Space background
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

      // Stars moving (parallax effect)
      for (let i = 0; i < 150; i++) {
        const starX = (i * 137) % CANVAS_WIDTH;
        const starY = ((i * 193 + time.value * 100) % CANVAS_HEIGHT);
        const size = (i % 3) + 1;
        const brightness = 100 + (i % 156);
        
        ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
        ctx.beginPath();
        ctx.arc(starX, starY, size, 0, Math.PI * 2);
        ctx.fill();
      }

      // Update and draw enemies (TIE Fighters)
      setEnemies(prev => {
        return prev.map(enemy => {
          enemy.y += enemy.speed;
          enemy.x += enemy.vx;

          // Bounce off walls
          if (enemy.x < enemy.size / 2 || enemy.x > CANVAS_WIDTH - enemy.size / 2) {
            enemy.vx *= -1;
          }

          // Check if passed screen
          if (enemy.y > CANVAS_HEIGHT + enemy.size) {
            setHealth(h => Math.max(0, h - 10));
            return null;
          }

          return enemy;
        }).filter(e => e !== null);
      });

      // Check if enemy is in crosshair
      let locked = null;
      enemies.forEach(enemy => {
        const dx = enemy.x - crosshairPos.x; // 조준선 위치 사용
        const dy = enemy.y - crosshairPos.y; // 조준선 위치 사용
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < CROSSHAIR_SIZE && !locked) {
          locked = enemy;
        }
      });
      setTargetLocked(locked);

      // Auto fire at locked target
      if (locked && Math.random() < 0.1) {
        setLasers(prev => [...prev, {
          id: Date.now() + Math.random(),
          x: crosshairPos.x, // 조준선 위치에서 발사
          y: crosshairPos.y, // 조준선 위치에서 발사
          targetX: locked.x,
          targetY: locked.y,
          speed: 15
        }]);
      }

      // Draw TIE Fighters
      enemies.forEach(enemy => {
        const isLocked = locked && locked.id === enemy.id;
        
        // Shadow
        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
        ctx.fillRect(enemy.x - enemy.size / 2 + 5, enemy.y - enemy.size / 2 + 5, enemy.size, enemy.size);

        // Target lock indicator
        if (isLocked) {
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 3;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.arc(enemy.x, enemy.y, enemy.size / 2 + 10, 0, Math.PI * 2);
          ctx.stroke();
          ctx.setLineDash([]);
          
          // Lock text
          ctx.fillStyle = '#ff0000';
          ctx.font = 'bold 16px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('LOCKED', enemy.x, enemy.y - enemy.size / 2 - 20);
        }

        // TIE Fighter body (hexagonal wings)
        ctx.fillStyle = '#444';
        ctx.beginPath();
        // Left wing
        ctx.rect(enemy.x - enemy.size / 2, enemy.y - enemy.size / 3, enemy.size / 3, enemy.size * 2 / 3);
        ctx.fill();
        
        // Right wing
        ctx.beginPath();
        ctx.rect(enemy.x + enemy.size / 6, enemy.y - enemy.size / 3, enemy.size / 3, enemy.size * 2 / 3);
        ctx.fill();

        // Cockpit (sphere)
        const gradient = ctx.createRadialGradient(enemy.x, enemy.y, 0, enemy.x, enemy.y, enemy.size / 4);
        gradient.addColorStop(0, '#666');
        gradient.addColorStop(1, '#333');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size / 4, 0, Math.PI * 2);
        ctx.fill();

        // Window
        ctx.fillStyle = '#00ffff';
        ctx.shadowColor = '#00ffff';
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size / 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Health bar
        if (enemy.health < enemy.maxHealth) {
          const barWidth = enemy.size;
          const barHeight = 5;
          const barX = enemy.x - barWidth / 2;
          const barY = enemy.y - enemy.size / 2 - 10;

          ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
          ctx.fillRect(barX, barY, barWidth, barHeight);

          ctx.fillStyle = '#00ff00';
          ctx.fillRect(barX, barY, barWidth * (enemy.health / enemy.maxHealth), barHeight);
        }
      });

      // Update and draw lasers
      setLasers(prev => {
        return prev.map(laser => {
          const dx = laser.targetX - laser.x;
          const dy = laser.targetY - laser.y;
          const angle = Math.atan2(dy, dx);
          
          laser.x += Math.cos(angle) * laser.speed;
          laser.y += Math.sin(angle) * laser.speed;

          // Check collision with enemies
          let hit = false;
          setEnemies(prevEnemies => {
            return prevEnemies.map(enemy => {
              const distance = Math.sqrt(
                Math.pow(enemy.x - laser.x, 2) + 
                Math.pow(enemy.y - laser.y, 2)
              );

              if (distance < enemy.size / 2 && !hit) {
                hit = true;
                enemy.health -= 1;

                if (enemy.health <= 0) {
                  setScore(s => s + 100);
                  setKills(k => k + 1);

                  // Explosion
                  setExplosions(exp => [...exp, {
                    id: Date.now() + Math.random(),
                    x: enemy.x,
                    y: enemy.y,
                    frame: 0
                  }]);

                  return null;
                }
              }
              return enemy;
            }).filter(e => e !== null);
          });

          if (hit || laser.x < 0 || laser.x > CANVAS_WIDTH || laser.y < 0 || laser.y > CANVAS_HEIGHT) {
            return null;
          }

          return laser;
        }).filter(l => l !== null);
      });

      // Draw lasers (X-Wing style - green and red)
      lasers.forEach((laser, index) => {
        const color = index % 2 === 0 ? '#00ff00' : '#ff0000';
        
        ctx.strokeStyle = color;
        ctx.lineWidth = 4;
        ctx.shadowColor = color;
        ctx.shadowBlur = 15;
        ctx.lineCap = 'round';
        
        const dx = laser.targetX - laser.x;
        const dy = laser.targetY - laser.y;
        const angle = Math.atan2(dy, dx);
        const length = 30;
        
        ctx.beginPath();
        ctx.moveTo(laser.x, laser.y);
        ctx.lineTo(laser.x - Math.cos(angle) * length, laser.y - Math.sin(angle) * length);
        ctx.stroke();
        ctx.shadowBlur = 0;
      });

      // Update and draw explosions
      setExplosions(prev => {
        return prev.map(exp => {
          exp.frame += 1;
          if (exp.frame > 20) return null;
          return exp;
        }).filter(e => e !== null);
      });

      explosions.forEach(exp => {
        const size = exp.frame * 5;
        const alpha = 1 - exp.frame / 20;
        
        // Outer explosion
        ctx.fillStyle = `rgba(255, 100, 0, ${alpha})`;
        ctx.beginPath();
        ctx.arc(exp.x, exp.y, size, 0, Math.PI * 2);
        ctx.fill();
        
        // Inner explosion
        ctx.fillStyle = `rgba(255, 255, 0, ${alpha})`;
        ctx.beginPath();
        ctx.arc(exp.x, exp.y, size * 0.6, 0, Math.PI * 2);
        ctx.fill();
        
        // Core
        ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
        ctx.beginPath();
        ctx.arc(exp.x, exp.y, size * 0.3, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw crosshair (드래그 가능)
      const centerX = crosshairPos.x;
      const centerY = crosshairPos.y;
      
      ctx.strokeStyle = locked ? '#ff0000' : '#00ff00';
      ctx.lineWidth = 3;
      ctx.shadowColor = locked ? '#ff0000' : '#00ff00';
      ctx.shadowBlur = 10;
      
      // Outer circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, CROSSHAIR_SIZE, 0, Math.PI * 2);
      ctx.stroke();
      
      // Inner circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
      ctx.stroke();
      
      // Cross lines
      ctx.beginPath();
      ctx.moveTo(centerX - CROSSHAIR_SIZE - 20, centerY);
      ctx.lineTo(centerX - CROSSHAIR_SIZE, centerY);
      ctx.moveTo(centerX + CROSSHAIR_SIZE, centerY);
      ctx.lineTo(centerX + CROSSHAIR_SIZE + 20, centerY);
      ctx.moveTo(centerX, centerY - CROSSHAIR_SIZE - 20);
      ctx.lineTo(centerX, centerY - CROSSHAIR_SIZE);
      ctx.moveTo(centerX, centerY + CROSSHAIR_SIZE);
      ctx.lineTo(centerX, centerY + CROSSHAIR_SIZE + 20);
      ctx.stroke();
      
      ctx.shadowBlur = 0;
      
      // Lock indicator
      if (locked) {
        ctx.fillStyle = '#ff0000';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('TARGET LOCKED', centerX, centerY + CROSSHAIR_SIZE + 40);
      }

      animationFrameId = requestAnimationFrame(gameLoop);
    };

    gameLoop();

    return () => {
      cancelAnimationFrame(animationFrameId);
    };
  }, [gameState, enemies, lasers, explosions, targetLocked, crosshairPos]); // crosshairPos 추가

  // 마우스/터치 드래그 핸들러
  const handleMove = (e) => {
    if (gameState !== 'playing') return;

    const rect = canvasRef.current.getBoundingClientRect();
    const clientX = e.clientX || e.touches?.[0]?.clientX;
    const clientY = e.clientY || e.touches?.[0]?.clientY;
    
    if (!clientX || !clientY) return;

    const x = clientX - rect.left;
    const y = clientY - rect.top;

    // Scale to canvas coordinates
    const scaleX = CANVAS_WIDTH / rect.width;
    const scaleY = CANVAS_HEIGHT / rect.height;
    const canvasX = x * scaleX;
    const canvasY = y * scaleY;

    setCrosshairPos({ x: canvasX, y: canvasY });
  };

  const startGame = () => {
    setGameState('playing');
    setScore(0);
    setKills(0);
    setHealth(100);
    setEnemies([]);
    setLasers([]);
    setExplosions([]);
    setTargetLocked(null);
    setCrosshairPos({ x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 2 }); // 조준선 중앙으로 초기화
  };

  if (gameState === 'menu') {
    return (
      <div className="flex items-center justify-center min-h-screen bg-black">
        <div className="text-center text-white p-8 bg-gray-900 bg-opacity-90 rounded-3xl max-w-2xl mx-4 border-4 border-yellow-500">
          <div className="mb-6">
            <div className="text-8xl mb-4">✈️⚔️</div>
            <h1 className="text-7xl font-bold mb-2 text-yellow-400" style={{ fontFamily: 'Impact, sans-serif' }}>
              X-WING
            </h1>
            <h2 className="text-3xl font-bold mb-4 text-blue-400">타이파이터 헌터</h2>
            <p className="text-gray-300 text-xl">조준선에 적을 잡아라!</p>
          </div>

          {highScore > 0 && (
            <div className="bg-yellow-900 bg-opacity-50 rounded-2xl p-4 mb-6 border-2 border-yellow-500">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Trophy className="w-6 h-6 text-yellow-400" />
                <span className="text-yellow-300 font-bold">최고 기록</span>
              </div>
              <div className="text-4xl font-bold text-yellow-400">{highScore.toLocaleString()}</div>
            </div>
          )}

          <button
            onClick={startGame}
            className="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-6 px-8 rounded-2xl text-3xl mb-6 transform hover:scale-105 transition shadow-2xl border-4 border-yellow-600"
          >
            🚀 출격
          </button>

          <div className="text-left bg-black bg-opacity-80 p-6 rounded-2xl space-y-3 border-2 border-blue-500">
            <h3 className="text-2xl font-bold mb-3 text-yellow-400">🎮 게임 방법</h3>
            <p className="text-green-400 text-xl font-bold">🖱️ 마우스/손가락을 움직여 조준!</p>
            <p className="text-gray-300 text-lg">⊕ 조준선을 드래그해서 움직입니다</p>
            <p className="text-gray-300 text-lg">🎯 타이파이터에 조준선을 맞추면...</p>
            <p className="text-green-400 text-xl font-bold">💥 자동으로 레이저 발사!</p>
            <p className="text-gray-300 text-lg">👾 TIE Fighter HP: 3</p>
            <p className="text-red-400 text-lg">⚠️ 적이 화면을 벗어나면 체력 -10</p>
            <div className="mt-4 p-4 bg-red-900 bg-opacity-50 rounded-lg border border-red-500">
              <p className="text-yellow-300 font-bold">💡 팁:</p>
              <p className="text-sm text-gray-300">적이 큽니다! 조준이 쉬워요!</p>
              <p className="text-sm text-gray-300">빨간 테두리 = 타겟 락온!</p>
              <p className="text-sm text-green-300">드래그해서 빠르게 조준하세요!</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (gameState === 'gameover') {
    return (
      <div className="flex items-center justify-center min-h-screen bg-black">
        <div className="text-center text-white p-8 bg-gray-900 bg-opacity-90 rounded-3xl max-w-md mx-4 border-4 border-red-500">
          <div className="mb-6">
            <div className="text-7xl mb-4">💥</div>
            <h1 className="text-5xl font-bold mb-4 text-red-400">격추됨!</h1>
          </div>

          <div className="bg-blue-900 bg-opacity-50 rounded-2xl p-6 mb-6 border-2 border-blue-500">
            <p className="text-gray-300 mb-2">최종 점수</p>
            <div className="text-6xl font-bold mb-4 text-yellow-400">{score.toLocaleString()}</div>
            {score === highScore && score > 0 && (
              <div className="bg-yellow-500 text-black font-bold py-2 px-4 rounded-full inline-block">
                🎉 신기록!
              </div>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-purple-900 bg-opacity-50 rounded-2xl p-4 border border-purple-500">
              <Target className="w-6 h-6 mx-auto mb-2 text-purple-400" />
              <p className="text-sm text-gray-300">격추</p>
              <p className="text-2xl font-bold">{kills}</p>
            </div>
            <div className="bg-orange-900 bg-opacity-50 rounded-2xl p-4 border border-orange-500">
              <Star className="w-6 h-6 mx-auto mb-2 text-yellow-400" />
              <p className="text-sm text-gray-300">평균</p>
              <p className="text-2xl font-bold">{kills > 0 ? Math.round(score / kills) : 0}</p>
            </div>
          </div>

          {highScore > 0 && score !== highScore && (
            <div className="bg-gray-800 bg-opacity-50 rounded-2xl p-4 mb-6 border border-gray-600">
              <p className="text-gray-400 text-sm mb-1">최고 기록</p>
              <p className="text-2xl font-bold text-yellow-400">{highScore.toLocaleString()}</p>
            </div>
          )}

          <button
            onClick={startGame}
            className="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-5 px-8 rounded-2xl text-2xl transform hover:scale-105 transition shadow-2xl border-4 border-yellow-600"
          >
            🔄 재출격
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-black p-4">
      {/* HUD */}
      <div className="flex gap-4 mb-4 flex-wrap justify-center">
        <div className="bg-black bg-opacity-90 px-6 py-3 rounded-xl text-white flex items-center gap-2 border-2 border-yellow-500">
          <Trophy className="w-6 h-6 text-yellow-400" />
          <div>
            <div className="text-xs text-gray-400">SCORE</div>
            <div className="font-bold text-xl text-yellow-400">{score.toLocaleString()}</div>
          </div>
        </div>
        <div className="bg-black bg-opacity-90 px-6 py-3 rounded-xl text-white flex items-center gap-2 border-2 border-green-500">
          <Shield className="w-6 h-6 text-green-400" />
          <div>
            <div className="text-xs text-gray-400">SHIELDS</div>
            <div className="w-32 bg-gray-700 rounded-full h-3 border border-green-400">
              <div
                className={`h-3 rounded-full transition-all ${
                  health > 50 ? 'bg-gradient-to-r from-green-500 to-emerald-500' :
                  health > 20 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                  'bg-gradient-to-r from-red-500 to-pink-500'
                }`}
                style={{ width: `${health}%` }}
              ></div>
            </div>
          </div>
        </div>
        <div className="bg-black bg-opacity-90 px-6 py-3 rounded-xl text-white flex items-center gap-2 border-2 border-red-500">
          <Target className="w-6 h-6 text-red-400" />
          <div>
            <div className="text-xs text-gray-400">KILLS</div>
            <div className="font-bold text-xl text-red-400">{kills}</div>
          </div>
        </div>
        {targetLocked && (
          <div className="bg-red-600 bg-opacity-90 px-6 py-3 rounded-xl text-white flex items-center gap-2 animate-pulse border-2 border-red-400">
            <Zap className="w-6 h-6" />
            <div className="font-bold text-xl">LOCKED</div>
          </div>
        )}
      </div>

      <canvas
        ref={canvasRef}
        width={CANVAS_WIDTH}
        height={CANVAS_HEIGHT}
        onMouseMove={handleMove}
        onTouchMove={handleMove}
        className="border-4 border-yellow-500 rounded-2xl shadow-2xl shadow-yellow-500/50 cursor-crosshair"
        style={{ maxWidth: '100%', height: 'auto' }}
      />

      <div className="mt-4 text-white text-center bg-black bg-opacity-90 p-4 rounded-2xl max-w-2xl border-2 border-green-500">
        <p className="text-lg font-bold mb-2 text-green-400">
          {targetLocked ? '🎯 TARGET LOCKED - FIRING!' : 
           enemies.length > 5 ? '⚠️ MULTIPLE BOGEYS!' :
           enemies.length > 0 ? '👾 ENEMY DETECTED' :
           '✨ SCANNERS CLEAR'}
        </p>
        <p className="text-sm text-gray-400">
          마우스/손가락을 움직여 조준선을 조종하세요! • 적: {enemies.length}
        </p>
      </div>
    </div>
  );
};

export default XWingGame;