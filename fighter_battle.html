<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
    <meta name="mobile-web-app-capable" content="yes">
    <title>íŒŒì´í„° ë°°í‹€ - 2ì¸ ê²©íˆ¬ ê²Œì„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overflow: hidden;
            touch-action: none;
            font-family: 'Malgun Gothic', sans-serif;
            background: #000;
        }
        #gameCanvas {
            display: block;
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
            touch-action: none;
        }
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            padding: 20px;
            background: rgba(0,0,0,0.9);
            border-radius: 20px;
            max-width: 90%;
            width: 600px;
            z-index: 10;
        }
        h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }
        .instructions {
            font-size: 18px;
            line-height: 1.8;
            margin: 20px 0;
            text-align: left;
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .player-controls {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }
        .player-controls h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .button:active {
            transform: scale(0.95);
        }
        .highscore {
            font-size: 20px;
            margin: 15px 0;
            color: #ffd700;
        }
        #gameInfo {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 5;
        }
        .player-hud {
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 10px;
            min-width: 200px;
        }
        .player-hud h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .health-bar {
            width: 200px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #666;
            position: relative;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ff8844 100%);
            transition: width 0.3s;
            border-radius: 12px;
        }
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        #timer {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px 30px;
            border-radius: 10px;
            z-index: 5;
        }
        .mobile-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 5;
        }
        .control-group {
            display: flex;
            gap: 10px;
        }
        .mobile-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
        }
        .mobile-btn:active {
            background: rgba(255,255,255,0.5);
        }
        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="menuScreen" class="screen">
        <h1>âš”ï¸ íŒŒì´í„° ë°°í‹€</h1>
        <div class="instructions">
            <strong>ê²Œì„ ë°©ë²•:</strong><br>
            â€¢ 2ëª…ì´ì„œ ë™ì‹œì— í”Œë ˆì´í•˜ëŠ” ê²©íˆ¬ ê²Œì„!<br>
            â€¢ ìƒëŒ€ì˜ ì²´ë ¥ì„ 0ìœ¼ë¡œ ë§Œë“¤ê±°ë‚˜ ì‹œê°„ ë‚´ì— ë” ë§ì€ ì²´ë ¥ì„ ìœ ì§€í•˜ì„¸ìš”!<br>
            â€¢ <strong>ì•‰ê¸°:</strong> ì„œì„œ í•˜ëŠ” ê³µê²© íšŒí”¼ ê°€ëŠ¥!<br>
            â€¢ <strong>ì í”„:</strong> ì•‰ì•„ì„œ í•˜ëŠ” ê³µê²© íšŒí”¼ ê°€ëŠ¥!<br>
            â€¢ <strong>ë°©ì–´:</strong> ë°ë¯¸ì§€ 50% ê°ì†Œ, ë°©ì–´ ì„±ê³µ ì‹œ 1ì´ˆ ì¿¨íƒ€ì„!<br>
            â€¢ ë°©ì–´ ì¤‘ì—ëŠ” ê³µê²© ë¶ˆê°€!<br><br>
        </div>
        <div class="controls">
            <div class="player-controls">
                <h3>ğŸ”´ í”Œë ˆì´ì–´ 1 (ë¹¨ê°•)</h3>
                â€¢ W - ì í”„ / S - ì•‰ê¸°<br>
                â€¢ A, D - ì¢Œìš° ì´ë™<br>
                â€¢ F - ê³µê²©<br>
                â€¢ Shift - ë°©ì–´
            </div>
            <div class="player-controls">
                <h3>ğŸ”µ í”Œë ˆì´ì–´ 2 (íŒŒë‘)</h3>
                â€¢ â†‘ - ì í”„ / â†“ - ì•‰ê¸°<br>
                â€¢ â†, â†’ - ì¢Œìš° ì´ë™<br>
                â€¢ Enter - ê³µê²©<br>
                â€¢ ìš°ì¸¡ Shift - ë°©ì–´
            </div>
        </div>
        <div class="highscore">ìµœë‹¤ ìŠ¹ë¦¬: <span id="menuHighScore">P1: 0 / P2: 0</span></div>
        <button class="button" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    </div>
    <div id="gameoverScreen" class="screen" style="display:none;">
        <h1>ğŸ† ê²Œì„ ì¢…ë£Œ!</h1>
        <div style="font-size: 32px; margin: 30px 0;">
            <div id="winner"></div>
        </div>
        <div class="highscore">ìŠ¹ìˆ˜: <span id="gameoverScore">P1: 0 / P2: 0</span></div>
        <button class="button" onclick="startGame()">ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="button" onclick="showMenu()">ë©”ë‰´ë¡œ</button>
    </div>
    <div id="gameInfo" style="display:none;">
        <div class="player-hud" style="color: #ff4444;">
            <h2>ğŸ”´ í”Œë ˆì´ì–´ 1</h2>
            <div class="health-bar">
                <div class="health-fill" id="p1Health" style="width: 100%;"></div>
                <div class="health-text" id="p1HealthText">100</div>
            </div>
        </div>
        <div class="player-hud" style="color: #4444ff;">
            <h2>ğŸ”µ í”Œë ˆì´ì–´ 2</h2>
            <div class="health-bar">
                <div class="health-fill" id="p2Health" style="width: 100%;"></div>
                <div class="health-text" id="p2HealthText">100</div>
            </div>
        </div>
    </div>
    <div id="timer" style="display:none;">60</div>

    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <div class="control-group">
            <div class="mobile-btn" id="p1Left">â†</div>
            <div class="mobile-btn" id="p1Right">â†’</div>
            <div class="mobile-btn" id="p1Attack">âš”ï¸</div>
            <div class="mobile-btn" id="p1Defend">ğŸ›¡ï¸</div>
        </div>
        <div class="control-group">
            <div class="mobile-btn" id="p2Left">â†</div>
            <div class="mobile-btn" id="p2Right">â†’</div>
            <div class="mobile-btn" id="p2Attack">âš”ï¸</div>
            <div class="mobile-btn" id="p2Defend">ğŸ›¡ï¸</div>
        </div>
    </div>

    <script>
        // Viewport height fix
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        window.addEventListener('resize', () => {
            vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameState = 'menu';
        let timeLeft = 60;
        let timerInterval;

        // Audio
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playSound(soundType) {
            try {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(soundType) {
                    case 'hit':
                        oscillator.frequency.value = 200;
                        gainNode.gain.value = 0.10;
                        oscillator.type = 'square';
                        break;
                    case 'defend':
                        oscillator.frequency.value = 600;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'sine';
                        break;
                    case 'win':
                        oscillator.frequency.value = 800;
                        gainNode.gain.value = 0.12;
                        oscillator.type = 'sine';
                        break;
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {}
        }

        // Players
        const player1 = {
            x: 200,
            y: canvas.height - 200,
            width: 50,
            height: 100,
            standingHeight: 100,
            crouchingHeight: 60,
            color: '#ff4444',
            health: 100,
            maxHealth: 100,
            velocityX: 0,
            velocityY: 0,
            speed: 5,
            jumpPower: 15,
            gravity: 0.8,
            isJumping: false,
            isCrouching: false,
            isAttacking: false,
            isDefending: false,
            attackCooldown: 0,
            defendCooldown: 0,
            facing: 1, // 1 = right, -1 = left
            keys: {}
        };

        const player2 = {
            x: canvas.width - 260,
            y: canvas.height - 200,
            width: 50,
            height: 100,
            standingHeight: 100,
            crouchingHeight: 60,
            color: '#4444ff',
            health: 100,
            maxHealth: 100,
            velocityX: 0,
            velocityY: 0,
            speed: 5,
            jumpPower: 15,
            gravity: 0.8,
            isJumping: false,
            isCrouching: false,
            isAttacking: false,
            isDefending: false,
            attackCooldown: 0,
            defendCooldown: 0,
            facing: -1,
            keys: {}
        };

        let wins = { p1: 0, p2: 0 };

        // Load wins from localStorage
        const savedWins = localStorage.getItem('fighterBattle_wins');
        if (savedWins) {
            wins = JSON.parse(savedWins);
            updateWinsDisplay();
        }

        function updateWinsDisplay() {
            document.getElementById('menuHighScore').textContent = `P1: ${wins.p1} / P2: ${wins.p2}`;
            document.getElementById('gameoverScore').textContent = `P1: ${wins.p1} / P2: ${wins.p2}`;
        }

        function startGame() {
            gameState = 'playing';
            timeLeft = 60;

            player1.x = 200;
            player1.y = canvas.height - 200;
            player1.health = 100;
            player1.velocityX = 0;
            player1.velocityY = 0;
            player1.isJumping = false;
            player1.isCrouching = false;
            player1.isAttacking = false;
            player1.isDefending = false;
            player1.attackCooldown = 0;
            player1.defendCooldown = 0;
            player1.height = player1.standingHeight;
            player1.facing = 1;

            player2.x = canvas.width - 260;
            player2.y = canvas.height - 200;
            player2.health = 100;
            player2.velocityX = 0;
            player2.velocityY = 0;
            player2.isJumping = false;
            player2.isCrouching = false;
            player2.isAttacking = false;
            player2.isDefending = false;
            player2.attackCooldown = 0;
            player2.defendCooldown = 0;
            player2.height = player2.standingHeight;
            player2.facing = -1;

            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameoverScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'flex';
            document.getElementById('timer').style.display = 'block';

            updateHealthDisplay();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        function showMenu() {
            gameState = 'menu';
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('gameoverScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
        }

        function gameOver() {
            gameState = 'gameover';
            if (timerInterval) clearInterval(timerInterval);

            let winner;
            if (player1.health <= 0 && player2.health <= 0) {
                winner = 'ë¬´ìŠ¹ë¶€!';
            } else if (player1.health <= 0) {
                winner = 'ğŸ”µ í”Œë ˆì´ì–´ 2 ìŠ¹ë¦¬!';
                wins.p2++;
            } else if (player2.health <= 0) {
                winner = 'ğŸ”´ í”Œë ˆì´ì–´ 1 ìŠ¹ë¦¬!';
                wins.p1++;
            } else if (player1.health > player2.health) {
                winner = 'ğŸ”´ í”Œë ˆì´ì–´ 1 ìŠ¹ë¦¬!';
                wins.p1++;
            } else if (player2.health > player1.health) {
                winner = 'ğŸ”µ í”Œë ˆì´ì–´ 2 ìŠ¹ë¦¬!';
                wins.p2++;
            } else {
                winner = 'ë¬´ìŠ¹ë¶€!';
            }

            localStorage.setItem('fighterBattle_wins', JSON.stringify(wins));
            updateWinsDisplay();

            document.getElementById('winner').textContent = winner;
            document.getElementById('gameoverScreen').style.display = 'block';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('timer').style.display = 'none';

            playSound('win');
        }

        function updateHealthDisplay() {
            const p1Percent = Math.max(0, (player1.health / player1.maxHealth) * 100);
            const p2Percent = Math.max(0, (player2.health / player2.maxHealth) * 100);

            document.getElementById('p1Health').style.width = p1Percent + '%';
            document.getElementById('p2Health').style.width = p2Percent + '%';
            document.getElementById('p1HealthText').textContent = Math.max(0, Math.round(player1.health));
            document.getElementById('p2HealthText').textContent = Math.max(0, Math.round(player2.health));

            if (player1.health <= 0 || player2.health <= 0) {
                gameOver();
            }
        }

        // Keyboard controls
        window.addEventListener('keydown', (e) => {
            if (gameState !== 'playing') return;

            // Player 1 controls
            if (e.key === 'w' || e.key === 'W') {
                if (!player1.isJumping && !player1.isCrouching) {
                    player1.velocityY = -player1.jumpPower;
                    player1.isJumping = true;
                }
            }
            if (e.key === 's' || e.key === 'S') {
                if (!player1.isJumping) {
                    player1.isCrouching = true;
                    player1.keys.crouch = true;
                }
            }
            if (e.key === 'a' || e.key === 'A') player1.keys.left = true;
            if (e.key === 'd' || e.key === 'D') player1.keys.right = true;
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                if (player1.attackCooldown <= 0 && !player1.isDefending) {
                    player1.isAttacking = true;
                    player1.attackCooldown = 30;
                }
            }
            if (e.key === 'Shift' && e.location === 1) { // Left Shift
                e.preventDefault();
                if (player1.defendCooldown <= 0) {
                    player1.isDefending = true;
                }
            }

            // Player 2 controls
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (!player2.isJumping && !player2.isCrouching) {
                    player2.velocityY = -player2.jumpPower;
                    player2.isJumping = true;
                }
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (!player2.isJumping) {
                    player2.isCrouching = true;
                    player2.keys.crouch = true;
                }
            }
            if (e.key === 'ArrowLeft') player2.keys.left = true;
            if (e.key === 'ArrowRight') player2.keys.right = true;
            if (e.key === 'Enter') {
                e.preventDefault();
                if (player2.attackCooldown <= 0 && !player2.isDefending) {
                    player2.isAttacking = true;
                    player2.attackCooldown = 30;
                }
            }
            if (e.key === 'Shift' && e.location === 2) { // Right Shift
                e.preventDefault();
                if (player2.defendCooldown <= 0) {
                    player2.isDefending = true;
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            // Player 1
            if (e.key === 's' || e.key === 'S') {
                player1.isCrouching = false;
                player1.keys.crouch = false;
            }
            if (e.key === 'a' || e.key === 'A') player1.keys.left = false;
            if (e.key === 'd' || e.key === 'D') player1.keys.right = false;
            if (e.key === 'Shift' && e.location === 1) player1.isDefending = false;

            // Player 2
            if (e.key === 'ArrowDown') {
                player2.isCrouching = false;
                player2.keys.crouch = false;
            }
            if (e.key === 'ArrowLeft') player2.keys.left = false;
            if (e.key === 'ArrowRight') player2.keys.right = false;
            if (e.key === 'Shift' && e.location === 2) player2.isDefending = false;
        });

        // Mobile controls
        function setupMobileControls() {
            document.getElementById('p1Left').addEventListener('touchstart', () => player1.keys.left = true);
            document.getElementById('p1Left').addEventListener('touchend', () => player1.keys.left = false);
            document.getElementById('p1Right').addEventListener('touchstart', () => player1.keys.right = true);
            document.getElementById('p1Right').addEventListener('touchend', () => player1.keys.right = false);
            document.getElementById('p1Attack').addEventListener('touchstart', () => {
                if (player1.attackCooldown <= 0) {
                    player1.isAttacking = true;
                    player1.attackCooldown = 30;
                }
            });
            document.getElementById('p1Defend').addEventListener('touchstart', () => player1.isDefending = true);
            document.getElementById('p1Defend').addEventListener('touchend', () => player1.isDefending = false);

            document.getElementById('p2Left').addEventListener('touchstart', () => player2.keys.left = true);
            document.getElementById('p2Left').addEventListener('touchend', () => player2.keys.left = false);
            document.getElementById('p2Right').addEventListener('touchstart', () => player2.keys.right = true);
            document.getElementById('p2Right').addEventListener('touchend', () => player2.keys.right = false);
            document.getElementById('p2Attack').addEventListener('touchstart', () => {
                if (player2.attackCooldown <= 0) {
                    player2.isAttacking = true;
                    player2.attackCooldown = 30;
                }
            });
            document.getElementById('p2Defend').addEventListener('touchstart', () => player2.isDefending = true);
            document.getElementById('p2Defend').addEventListener('touchend', () => player2.isDefending = false);
        }
        setupMobileControls();

        function updatePlayer(player) {
            // Crouching
            if (player.isCrouching && !player.isJumping) {
                player.height = player.crouchingHeight;
            } else {
                player.height = player.standingHeight;
            }

            // Horizontal movement (slower when crouching)
            player.velocityX = 0;
            const moveSpeed = player.isCrouching ? player.speed * 0.5 : player.speed;

            if (player.keys.left) {
                player.velocityX = -moveSpeed;
                player.facing = -1;
            }
            if (player.keys.right) {
                player.velocityX = moveSpeed;
                player.facing = 1;
            }

            // Apply gravity
            player.velocityY += player.gravity;

            // Update position
            player.x += player.velocityX;
            player.y += player.velocityY;

            // Ground collision
            const ground = canvas.height - 100;
            if (player.y + player.height >= ground) {
                player.y = ground - player.height;
                player.velocityY = 0;
                player.isJumping = false;
            }

            // Boundary check
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // Attack cooldown
            if (player.attackCooldown > 0) {
                player.attackCooldown--;
            }

            // Defend cooldown
            if (player.defendCooldown > 0) {
                player.defendCooldown--;
            }

            // Attack duration
            if (player.isAttacking) {
                setTimeout(() => {
                    player.isAttacking = false;
                }, 200);
            }
        }

        function checkCollision(attacker, defender) {
            if (!attacker.isAttacking) return false;

            const attackRange = 80;
            const horizontalDist = Math.abs(attacker.x - defender.x);

            if (horizontalDist > attackRange) return false;

            // Attacker is crouching (low attack)
            if (attacker.isCrouching) {
                // Low attacks miss jumping opponents
                if (defender.isJumping) return false;
            }
            // Attacker is standing (high attack)
            else {
                // High attacks miss crouching opponents
                if (defender.isCrouching) return false;
            }

            // Defender is blocking
            if (defender.isDefending) {
                // Successful block - apply defend cooldown
                defender.defendCooldown = 60; // 1 second cooldown
                return 'blocked';
            }

            return true;
        }

        function handleCombat() {
            // Player 1 attacks Player 2
            const p1Hit = checkCollision(player1, player2);
            if (p1Hit === true) {
                player2.health -= 10;
                playSound('hit');
                updateHealthDisplay();
                player1.isAttacking = false;
            } else if (p1Hit === 'blocked') {
                player2.health -= 5;
                playSound('defend');
                updateHealthDisplay();
                player1.isAttacking = false;
            }

            // Player 2 attacks Player 1
            const p2Hit = checkCollision(player2, player1);
            if (p2Hit === true) {
                player1.health -= 10;
                playSound('hit');
                updateHealthDisplay();
                player2.isAttacking = false;
            } else if (p2Hit === 'blocked') {
                player1.health -= 5;
                playSound('defend');
                updateHealthDisplay();
                player2.isAttacking = false;
            }
        }

        function drawPlayer(player) {
            const centerX = player.x + player.width / 2;
            const centerY = player.y + player.height / 2;

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(centerX, canvas.height - 95, player.width / 2, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Head
            const headY = player.isCrouching ? player.y + 10 : player.y - 15;
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(centerX, headY, 18, 0, Math.PI * 2);
            ctx.fill();

            // Eyes
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(centerX - 6, headY - 3, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 6, headY - 3, 4, 0, Math.PI * 2);
            ctx.fill();

            // Pupils
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(centerX - 6 + (player.facing * 2), headY - 3, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 6 + (player.facing * 2), headY - 3, 2, 0, Math.PI * 2);
            ctx.fill();

            // Body (torso)
            const bodyY = player.isCrouching ? player.y + 25 : player.y + 5;
            const bodyHeight = player.isCrouching ? 35 : 50;
            ctx.fillStyle = player.color;
            ctx.fillRect(centerX - 15, bodyY, 30, bodyHeight);

            // Arms
            ctx.strokeStyle = player.color;
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';

            if (player.isAttacking) {
                // Punching arm
                const armX = centerX + (player.facing * 15);
                const armEndX = armX + (player.facing * 30);
                ctx.beginPath();
                ctx.moveTo(armX, bodyY + 15);
                ctx.lineTo(armEndX, bodyY + 15);
                ctx.stroke();
            } else if (player.isDefending) {
                // Both arms up defending
                ctx.beginPath();
                ctx.moveTo(centerX - 15, bodyY + 10);
                ctx.lineTo(centerX - 20, headY + 10);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(centerX + 15, bodyY + 10);
                ctx.lineTo(centerX + 20, headY + 10);
                ctx.stroke();
            } else {
                // Normal arms
                ctx.beginPath();
                ctx.moveTo(centerX - 15, bodyY + 15);
                ctx.lineTo(centerX - 20, bodyY + 35);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(centerX + 15, bodyY + 15);
                ctx.lineTo(centerX + 20, bodyY + 35);
                ctx.stroke();
            }

            // Legs
            const legY = bodyY + bodyHeight;
            if (player.isCrouching) {
                // Crouching legs
                ctx.beginPath();
                ctx.moveTo(centerX - 10, legY);
                ctx.lineTo(centerX - 15, legY + 20);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(centerX + 10, legY);
                ctx.lineTo(centerX + 15, legY + 20);
                ctx.stroke();
            } else if (player.isJumping) {
                // Jumping legs
                ctx.beginPath();
                ctx.moveTo(centerX - 10, legY);
                ctx.lineTo(centerX - 8, legY + 25);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(centerX + 10, legY);
                ctx.lineTo(centerX + 8, legY + 25);
                ctx.stroke();
            } else {
                // Standing legs
                ctx.beginPath();
                ctx.moveTo(centerX - 10, legY);
                ctx.lineTo(centerX - 10, legY + 30);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(centerX + 10, legY);
                ctx.lineTo(centerX + 10, legY + 30);
                ctx.stroke();
            }

            // Defending shield
            if (player.isDefending && player.defendCooldown <= 0) {
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(centerX, centerY, 45, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Defend cooldown indicator
            if (player.defendCooldown > 0) {
                ctx.fillStyle = 'rgba(255,0,0,0.5)';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ì¿¨íƒ€ì„', centerX, player.y - 45);
            }

            // Attack effect
            if (player.isAttacking) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                const attackX = centerX + (player.facing * 40);
                const attackY = player.isCrouching ? bodyY + 20 : bodyY + 15;

                // Impact effect
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.arc(attackX + (player.facing * i * 10), attackY, 8 - i * 2, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }

            // Health bar above player
            const barWidth = 60;
            const barHeight = 8;
            const barX = centerX - barWidth / 2;
            const barY = player.y - 40;

            ctx.fillStyle = '#333';
            ctx.fillRect(barX, barY, barWidth, barHeight);

            const healthPercent = player.health / player.maxHealth;
            ctx.fillStyle = healthPercent > 0.5 ? '#4ade80' : healthPercent > 0.25 ? '#fbbf24' : '#ef4444';
            ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(barX, barY, barWidth, barHeight);
        }

        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#4a5568');
            gradient.addColorStop(1, '#2d3748');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Ground
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);

            // Ground line
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - 100);
            ctx.lineTo(canvas.width, canvas.height - 100);
            ctx.stroke();
        }

        function gameLoop() {
            if (gameState === 'playing') {
                drawBackground();

                updatePlayer(player1);
                updatePlayer(player2);
                handleCombat();

                drawPlayer(player1);
                drawPlayer(player2);
            }

            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        updateWinsDisplay();
        gameLoop();
    </script>
</body>
</html>