# Memory Game (암기 퀴즈) 가이드

## 게임 개요

Memory Game은 마크다운 형식의 텍스트 파일을 기반으로 한 암기 학습 게임입니다. 사용자가 파일을 업로드하거나 공개 파일을 선택하면 **굵게 표시된 단어들을 답으로 제시**하는 방식의 학습 게임입니다.

## 게임 구조

### 세 가지 화면 상태

1. **메뉴 화면 (Menu)**
   - "마이 파일" 섹션: 로그인한 사용자의 파일 목록
   - "공개 파일" 섹션: is_public = true이고 is_shared = true인 파일 (조회수 상위 10개)
   - 파일 선택 시 게임 시작

2. **게임 화면 (Playing)**
   - **굵게 표시된 단어들을 빈칸(____)으로 변환**
   - 사용자가 각 빈칸에 정답을 입력
   - Hint 버튼으로 다음 글자 공개 (100 포인트 소비)
   - Submit 버튼으로 답 제출

3. **결과 화면 (Game Over)**
   - **최종 점수 표시** (0~100점)
   - **조회수 증가** (게임 완료 시, 공개 파일만)
   - 보너스 포인트 표시 (100점 만점일 때 1,200 포인트)
   - 정오표: 맞은 단어(초록색), 틀린 단어(빨간색) 표시
   - 누적 포인트 표시

## 게임 설정

### 게임 모드

| 모드명 | 값 | 설명 | 기본값 |
|--------|-----|------|--------|
| **무작위 모드** | `random` | 저빈도 단어 중심으로 출제 | - |
| **TTV 모드** | `bold` | 마크다운에서 **굵게 표시된** 단어만 출제 | ✅ 기본값 |

### 난이도 설정

| 모드 | 기본 난이도 | 범위 | 의미 |
|------|-----------|------|------|
| Random 모드 | 100% | 33% ~ 100% | 100% = 모든 저빈도 단어, 33% = 일부만 |
| TTV 모드 | 50% | 33% ~ 100% | 50% = 전체 굵은 단어의 50%만 출제 |

**설정 위치:** Memory.html 라인 3272
```javascript
const currentMode = localStorage.getItem('memory_game_mode') || 'bold';
// 'bold' = TTV 모드가 기본값
```

## 마크다운 파일 형식

게임이 정상 작동하려면 마크다운 파일이 다음 형식을 따라야 합니다:

### 예시
```markdown
# 애국가

## 1절
동해 물과 **백두산**이 마르고 닳도록
하느님이 **보우**하사 우리나라 만세
무궁화 삼천리 **화려강산**
대한 사람 대한으로 **길이** 보전하세
```

**규칙:**
- `# 제목` - 게임에서 제외 (출제 안 함)
- `**굵은 글자**` - TTV 모드에서 출제
- 일반 텍스트 - Random 모드에서 저빈도 단어 출제
- 표(|) - 셀 내용이 출제 대상

## 점수 계산

### 기본 점수 계산식

```
점수 = (맞은 단어 수 / 전체 빈칸 수) × 100
```

**코드 위치:** [Memory.html:4258](Memory.html#L4258)

### 점수 예시

| 상황 | 계산 | 결과 |
|------|------|------|
| 10개 중 7개 정답 | (7 / 10) × 100 | 70점 |
| 10개 중 10개 정답 | (10 / 10) × 100 | 100점 |
| 8개 중 4개 정답 | (4 / 8) × 100 | 50점 |

### 보너스 포인트

- **100점 만점:** +1,200 포인트 (축하 애니메이션 포함)
- 폭죽 효과와 함께 표시

## 조회수 시스템

### 조회수 증가 조건

- **파일이 공개 파일**이어야 함 (`is_public = true`)
- **게임을 완료**하고 결과 화면에 도달했을 때만 증가
- 파일 열기 시점이 아니라 **게임 완료 시점에 +1**

### 공개 파일 목록

- `is_public = true AND is_shared = true`인 파일만 표시
- 조회수 많은 순서로 정렬 (내림차순)
- **상위 10개 파일만 표시**
- 각 파일 옆에 👁️ 조회수 표시

## 주요 기능

### 1. Hint (힌트) 기능

- **비용:** 100 포인트
- **동작:** 첫 번째 틀린 글자부터 다음 글자까지 공개
- **예시:**
  - 정답: HELLO
  - 입력: HEL
  - 힌트 후: HELL (다음 글자까지 공개)

### 2. Share (공유) 기능

- 현재 게임 파일의 공유 링크 생성
- 공유 토큰 기반 URL로 타인이 파일 접근 가능
- 로그인하지 않은 사용자도 접근 가능 (읽기 전용)

### 3. Import (가져오기) 기능

- 공개 파일을 자신의 "마이 파일"로 복사
- 파일명에 "_복사본" 추가
- UUID 기반 저장소 경로로 관리
- 수정/삭제 가능 (소유자만)

### 4. Character-level Feedback

- 사용자가 입력할 때 **글자 단위로 피드백**
- 초록색 배경: 맞은 글자
- 주황색 테두리: 부분 정답
- 정확도가 시각적으로 표시됨

## 데이터 저장

### Supabase 테이블 구조

```
study_materials
├── id (UUID) - 파일 고유 ID
├── user_id (UUID) - 소유자 ID
├── title (TEXT) - 파일명 (한글 포함)
├── file_path (TEXT) - Storage 경로 (UUID 기반)
├── view_count (INTEGER) - 조회수 (기본값: 0)
├── is_public (BOOLEAN) - 공개 여부
├── is_shared (BOOLEAN) - 공유 여부
├── created_at (TIMESTAMP) - 생성일
└── updated_at (TIMESTAMP) - 수정일
```

### Storage 경로 형식

- **경로 패턴:** `${userId}/${fileId}.md`
- **예시:** `abc123def456/550e8400e29b41d4a716446655440000.md`
- 한글 파일명은 DB에만 저장, Storage 경로는 UUID로만 관리

## 로컬 저장소 (localStorage)

```javascript
// 게임 모드
memory_game_mode: 'bold' | 'random'

// 게임 난이도
memory_random_difficulty: 33~100
memory_bold_difficulty: 33~100

// 파일 캐시
file_cache_${fileId}: (파일 내용)

// 파일 메타데이터
supabase_file_meta_${fileId}: JSON

// 게스트 포인트
guest_total_points: (숫자)

// 로컬 파일
local_md_files: JSON Array
```

## 성능 최적화

### 캐싱 전략

- **첫 로드:** Supabase Storage에서 다운로드
- **재방문:** localStorage에서 캐시된 파일 로드 (즉시 표시)
- **업데이트 확인:** 메타데이터의 `updated_at` 비교

### 스크롤바 스타일

- Chrome/Edge: `scrollbar-width: thin`, 2px 굵기
- Firefox: `scrollbar-color`, 2px 굵기
- 시각적으로 깔끔한 UI 유지

## 문제 해결

### 파일이 열리지 않는 경우

1. **공개 파일:** `is_public = true AND is_shared = true` 확인
2. **개인 파일:** 로그인 후 "마이 파일"에서 선택
3. **Storage 권한:** Supabase RLS 정책 확인

### 조회수가 증가하지 않는 경우

1. 파일이 공개 파일(`is_public = true`)인지 확인
2. 게임을 **완료**(결과 화면까지)했는지 확인
3. 콘솔에서 에러 메시지 확인

### 점수가 저장되지 않는 경우

- Supabase 로그인 상태 확인
- 포인트 RPC 함수 호출 권한 확인
- 콘솔의 `addPoints()` 호출 로그 확인

## 개발자 노트

### 주요 함수

| 함수명 | 위치 | 기능 |
|--------|------|------|
| `startGame()` | ~3200 | 게임 초기화 및 시작 |
| `endGame()` | ~4433 | 게임 종료 및 결과 표시 |
| `parseLyrics()` | ~3635 | 마크다운 파싱 및 단어 추출 |
| `updateScore()` | ~4300 | 점수 계산 및 업데이트 |
| `displayOriginalText()` | ~4536 | 정오표 렌더링 |
| `loadPublicFiles()` | ~2899 | 공개 파일 목록 로드 |
| `updateAuthButton()` | ~3568 | 로그인/로그아웃 버튼 상태 |

### 게임 모드 자동 감지

```javascript
// Bold 패턴 감지 (**, 공백 포함)
const boldMatch = remaining.match(/^\s*\*\*([^*]+)\*\*/)

// 일반 텍스트 (공백도 포함)
const wordMatch = remaining.match(/^([^\s*]+|\s+|\*(?!\*)|[^\w*])/)
```

## 최신 업데이트

- **조회수 시스템:** 게임 완료 시에만 증가
- **단어 간격:** word-spacing 추가로 정오표 가독성 향상
- **캐릭터 피드백:** 입력 시 글자 단위 색상 표시
- **회원가입:** 사이드바에 직접 회원가입 버튼 추가
- **Storage RLS:** 공개 파일 접근 권한 관리
