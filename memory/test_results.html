<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>시험 성적 조회</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vh: 1vh;
            --primary: #6750a4;
            --primary-dark: #533e8a;
            --primary-light: #eaddff;
            --surface: #fffbfe;
            --surface-dim: #f3eff5;
            --outline: #79747e;
            --outline-variant: #ccc0d9;
            --text-primary: #1f1b28;
            --text-secondary: #49454e;
            --success: #52c41a;
            --error: #f5222d;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f5ff 0%, #faf7ff 100%);
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 16px;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--outline-variant);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-title .material-icons {
            font-size: 28px;
            color: var(--primary);
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: var(--surface-dim);
        }

        .back-btn .material-icons {
            font-size: 24px;
        }

        /* Main Content */
        .content {
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
        }

        /* Test Files List */
        .test-files-panel {
            width: 280px;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .files-header {
            padding: 16px;
            border-bottom: 1px solid var(--outline-variant);
            font-weight: 600;
            color: var(--text-primary);
        }

        .files-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--surface-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .file-item:hover {
            background: var(--surface-dim);
        }

        .file-item.active {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
        }

        .file-item-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .empty-files {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-secondary);
            text-align: center;
            padding: 24px;
            font-size: 14px;
        }

        /* Test Results Panel */
        .test-results-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .results-header {
            padding: 16px;
            border-bottom: 1px solid var(--outline-variant);
            font-weight: 600;
            color: var(--text-primary);
        }

        .results-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
        }

        .empty-results {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-secondary);
            text-align: center;
            font-size: 14px;
        }

        .result-item {
            padding: 12px;
            background: var(--surface-dim);
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--outline-variant);
        }

        .result-item.perfect {
            border-left-color: var(--success);
            background: rgba(82, 196, 26, 0.05);
        }

        .result-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .result-score {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .result-score.perfect {
            color: var(--success);
        }

        .result-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .result-perfect-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-secondary);
            padding: 24px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--outline-variant);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .test-files-panel {
                width: 100%;
                max-height: 200px;
            }

            .test-results-panel {
                flex: 1;
            }
        }

        /* Auth Status */
        .auth-required {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex: 1;
            color: var(--text-secondary);
        }

        .auth-required .material-icons {
            font-size: 48px;
            color: var(--outline);
        }

        .auth-required p {
            font-size: 14px;
        }

        .auth-required a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <span class="material-icons">assessment</span>
                <span>시험 성적 조회</span>
            </div>
            <button class="back-btn" id="backBtn">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Test Files List -->
            <div class="test-files-panel">
                <div class="files-header">테스트 파일</div>
                <div class="files-list" id="filesList">
                    <div class="empty-files">로드 중...</div>
                </div>
            </div>

            <!-- Test Results Panel -->
            <div class="test-results-panel">
                <div class="results-header">응시 현황</div>
                <div class="results-content" id="resultsContent">
                    <div class="empty-results">테스트 파일을 선택해주세요</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Initialize Supabase
        const supabase = window.supabase.createClient(
            'https://swbzqejqunxdcmcsgxpk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3YnpxZWpxdW54ZGNtY3NneHBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE0NTAwMDEsImV4cCI6MjA0NzAyNjAwMX0.Ej-MZ9QEfEjP3RhQGrHHrMPzWMm8xkxA8bwIKgzXsVA'
        );

        let currentUser = null;
        let selectedFileId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
        });

        // Check Authentication
        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;

                if (!user) {
                    showAuthRequired();
                    return;
                }

                loadTestFiles();
            } catch (error) {
                console.error('Auth check error:', error);
                showAuthRequired();
            }
        }

        // Show auth required message
        function showAuthRequired() {
            const container = document.querySelector('.content');
            container.innerHTML = `
                <div class="auth-required">
                    <span class="material-icons">lock</span>
                    <p>로그인이 필요합니다</p>
                    <a href="Memory.html">메인으로 돌아가기</a>
                </div>
            `;
        }

        // Load test files owned by current user
        async function loadTestFiles() {
            try {
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '<div class="loading"><div class="spinner"></div>로드 중...</div>';

                const { data: files, error } = await supabase
                    .from('study_materials')
                    .select('id, title')
                    .eq('user_id', currentUser.id)
                    .not('test_token', 'is', null)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!files || files.length === 0) {
                    filesList.innerHTML = '<div class="empty-files">테스트 파일이 없습니다</div>';
                    showEmptyResults();
                    return;
                }

                // Render file list
                filesList.innerHTML = files.map(file => `
                    <div class="file-item" data-file-id="${file.id}">
                        <div class="file-item-name">${escapeHtml(file.title)}</div>
                        <div class="file-item-count">클릭하여 보기</div>
                    </div>
                `).join('');

                // Add click handlers
                document.querySelectorAll('.file-item').forEach(item => {
                    item.addEventListener('click', () => selectFile(item));
                });

                // Auto-select first file
                if (files.length > 0) {
                    const firstItem = document.querySelector('.file-item');
                    selectFile(firstItem);
                }
            } catch (error) {
                console.error('Load test files error:', error);
                document.getElementById('filesList').innerHTML = '<div class="empty-files">오류 발생</div>';
            }
        }

        // Select file and load results
        async function selectFile(element) {
            // Remove active class from all items
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to selected item
            element.classList.add('active');
            selectedFileId = element.getAttribute('data-file-id');

            // Load results for this file
            await loadTestResults(selectedFileId);
        }

        // Load test results for selected file
        async function loadTestResults(fileId) {
            try {
                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div>로드 중...</div>';

                const { data: results, error } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('file_id', fileId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!results || results.length === 0) {
                    resultsContent.innerHTML = '<div class="empty-results">응시 기록이 없습니다</div>';
                    return;
                }

                // Render results
                const html = results.map(result => `
                    <div class="result-item ${result.score === 100 ? 'perfect' : ''}">
                        <div class="result-name">
                            ${escapeHtml(result.tester_name)}
                            ${result.score === 100 ? '<span class="result-perfect-badge">만점</span>' : ''}
                        </div>
                        <div class="result-score ${result.score === 100 ? 'perfect' : ''}">
                            ${result.score}점
                        </div>
                        <div class="result-date">
                            ${formatDate(result.created_at)}
                        </div>
                    </div>
                `).join('');

                resultsContent.innerHTML = html;
            } catch (error) {
                console.error('Load test results error:', error);
                document.getElementById('resultsContent').innerHTML = '<div class="empty-results">오류 발생</div>';
            }
        }

        // Show empty results
        function showEmptyResults() {
            document.getElementById('resultsContent').innerHTML = '<div class="empty-results">테스트 파일을 선택해주세요</div>';
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'Memory.html';
            });
        }

        // Utility: Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // Utility: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
