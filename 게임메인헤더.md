# 게임 메인 헤더 구조 가이드

이 문서는 게임 플레이 중 화면의 헤더(통계 바) 구조를 정의합니다.

## 1. 기본 HTML 구조

### Game Container & Stats Header
```html
<div id="gameContainer" class="game-container hidden">
    <div class="stats">
        <a href="#" class="back-btn-game" onclick="handleGameExit(event)">
            <span class="material-icons">arrow_back</span>
        </a>
        <div class="stat-item">
            <div class="stat-label">Score</div>
            <div class="stat-value" id="score">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Shields</div>
            <div class="stat-value" id="shields">100</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Kills</div>
            <div class="stat-value" id="kills">0</div>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
</div>
```

---

## 2. CSS 스타일

### Stats Header (통계 바)
```css
.stats {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    font-size: 1em;
    border-bottom: 2px solid rgba(255, 204, 0, 0.5);
    gap: 8px;
}
```

**핵심 포인트:**
- `display: flex` - 가로 배치
- `align-items: center` - 세로 중앙 정렬
- `gap: 8px` - 요소 간 간격
- `justify-content: space-around` - 요소들 균등 배치

### Back Button (이전 버튼)
```css
.back-btn-game {
    background: transparent;
    border: none;
    color: #ffcc00;  /* 게임 테마 색상 */
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    border-radius: 50%;
    transition: background 0.2s ease;
    width: 36px;
    height: 36px;
    flex-shrink: 0;  /* 중요: 버튼 크기 고정 */
}

.back-btn-game .material-icons {
    font-size: 24px;
}

.back-btn-game:hover {
    background: rgba(255, 204, 0, 0.1);
}

.back-btn-game:active {
    background: rgba(255, 204, 0, 0.2);
}
```

**핵심 포인트:**
- `flex-shrink: 0` - 화면이 좁아져도 버튼 크기 유지
- `border-radius: 50%` - 원형 버튼
- Material Icons 사용
- 게임 테마에 맞는 색상 사용

### Stat Item (통계 항목)
```css
.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-label {
    font-size: 0.7em;
    opacity: 0.8;
    color: #ffcc00;  /* 게임 테마 색상 */
    text-transform: uppercase;
}

.stat-value {
    font-size: 1.4em;
    font-weight: bold;
}
```

**핵심 포인트:**
- 라벨 위, 값 아래로 세로 배치
- 라벨은 작게, 값은 크고 bold
- 라벨 색상으로 테마 표현

---

## 3. JavaScript 로직

### 점수 시스템 (대포 디펜더 방식)

#### 변수 선언
```javascript
// Game state
let gameState = 'menu';
let score = 0; // 이번 판 점수 (게임 시작 시 0부터)
let shields = 100;
let kills = 0;
let highScore = localStorage.getItem('xwing_highScore') || 0;
```

**핵심 개념:**
- **score**: 이번 판 점수 (매 게임마다 0부터 시작)
- **통합 포인트**: Supabase에 누적되는 총 포인트 (getCurrentPoints()로 가져옴)

#### 게임 시작
```javascript
window.startGame = async function() {
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('gameoverScreen').classList.add('hidden');
    document.getElementById('gameContainer').classList.remove('hidden');

    gameState = 'playing';
    score = 0; // 이번 판 점수는 0부터 시작
    shields = 100;
    kills = 0;
    // ... 기타 초기화

    updateUI();
};
```

**핵심 포인트:**
- `score = 0` - 항상 0부터 시작
- 통합 포인트는 건드리지 않음

#### UI 업데이트
```javascript
function updateUI() {
    document.getElementById('score').textContent = score.toLocaleString();
    document.getElementById('shields').textContent = shields;
    document.getElementById('kills').textContent = kills;
}
```

#### 게임 종료 (정상 종료)
```javascript
async function endGame() {
    gameState = 'gameover';

    // Stop background music
    stopBackgroundMusic();

    const avgScore = kills > 0 ? Math.round(score / kills) : 0;

    // 게임 종료 시 이번 판 점수를 통합 포인트에 적립
    await addGamePoints(score, 'xwing');

    // 통합 포인트 가져오기
    const totalPoints = getCurrentPoints();

    // 화면 표시
    document.getElementById('finalScore').textContent = score.toLocaleString();
    document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
    document.getElementById('gameoverPoints').textContent = totalPoints.toLocaleString();
    document.getElementById('killCount').textContent = kills;
    document.getElementById('avgScore').textContent = avgScore;

    // 최고 기록 체크
    const isNewRecord = score > highScore;
    if (isNewRecord) {
        highScore = score;
        localStorage.setItem('xwing_highScore', highScore);
        document.getElementById('newRecord').classList.remove('hidden');
    }

    document.getElementById('gameoverScreen').classList.remove('hidden');
}
```

**핵심 포인트:**
1. `await addGamePoints(score, 'xwing')` - 이번 판 점수를 통합 포인트에 **더하기**
2. `getCurrentPoints()` - 업데이트된 통합 포인트 가져오기
3. 두 점수를 모두 화면에 표시

#### 게임 나가기 (이전 버튼)
```javascript
async function handleGameExit(event) {
    event.preventDefault();

    if (gameState === 'playing' && confirm('게임을 종료하시겠습니까?\n현재 점수가 통합 포인트에 저장됩니다.')) {
        gameState = 'exiting';

        // 음악 정지
        stopBackgroundMusic();

        // 현재 점수를 통합 포인트에 저장
        await addGamePoints(score, 'xwing');

        // 포인트 표시 업데이트
        updatePointsDisplay();

        // 메뉴로 돌아가기
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('menuScreen').classList.remove('hidden');

        gameState = 'menu';
    }
}
```

**핵심 포인트:**
1. `event.preventDefault()` - 링크 기본 동작 방지
2. `confirm()` - 사용자 확인
3. `await addGamePoints(score, 'xwing')` - 점수 저장
4. `updatePointsDisplay()` - 메뉴 화면 포인트 표시 업데이트
5. 화면 전환

---

## 4. Game Over 화면 점수 표시

### HTML 구조
```html
<div class="gameover-content">
    <div class="game-icon">💥</div>
    <h1>격추됨!</h1>

    <!-- 점수 정보 -->
    <div class="score-info" style="background: rgba(255,204,0,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="opacity: 0.8;">이번판 점수</span>
            <span style="font-size: 1.3em; font-weight: bold; color: #ffcc00;" id="finalScore">0</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span style="opacity: 0.8;">통합 포인트</span>
            <span style="font-size: 1.3em; font-weight: bold; color: #00ff00;" id="totalPoints">0</span>
        </div>
    </div>

    <!-- 기타 통계 -->
    <div class="stats-grid">
        <div class="stat-box">
            <div>격추</div>
            <div id="killCount">0</div>
        </div>
        <div class="stat-box">
            <div>평균 점수</div>
            <div id="avgScore">0</div>
        </div>
    </div>

    <button class="btn" onclick="startGame()">🔄 재출격</button>
</div>
```

**핵심 포인트:**
- **이번판 점수**: 이번 게임에서만 얻은 점수 (노란색)
- **통합 포인트**: 누적된 총 포인트 (초록색)
- `display: flex` + `justify-content: space-between` 으로 라벨과 값 좌우 배치

---

## 5. Supabase 통합

### 필요한 함수들
```javascript
// supabaseClient.js에서 제공하는 함수들

// 현재 통합 포인트 가져오기
getCurrentPoints()

// 게임 점수를 통합 포인트에 추가
await addGamePoints(gameScore, gameId)
// 예: await addGamePoints(score, 'xwing')

// 포인트 표시 업데이트
updatePointsDisplay()
```

### 포인트 표시 업데이트 함수
```javascript
function updatePointsDisplay() {
    const points = getCurrentPoints();
    const menuPointsEl = document.getElementById('menuPoints');
    const gameoverPointsEl = document.getElementById('gameoverPoints');

    if (menuPointsEl) menuPointsEl.textContent = points;
    if (gameoverPointsEl) gameoverPointsEl.textContent = points;
}

// 페이지 로드 시
window.addEventListener('DOMContentLoaded', async () => {
    await getCurrentSession();
    updatePointsDisplay();
});

// 로그인/로그아웃 시
window.addEventListener('userSignedIn', updatePointsDisplay);
window.addEventListener('userSignedOut', updatePointsDisplay);
```

---

## 6. 점수 시스템 흐름

```
게임 시작
  └─ score = 0 (이번 판 점수)
  └─ 통합 포인트는 그대로 유지

게임 진행
  └─ score += 점수 (이번 판 점수만 증가)
  └─ updateUI() 호출

게임 종료 (정상 종료 or 이전 버튼)
  └─ await addGamePoints(score, 'gameId')
      └─ 통합 포인트 += score
      └─ Supabase에 저장 (로그인 시) or localStorage (비로그인 시)
  └─ totalPoints = getCurrentPoints()
  └─ 화면에 표시
      - 이번판 점수: score
      - 통합 포인트: totalPoints
```

---

## 7. 체크리스트

게임에 점수 시스템을 적용할 때 확인:

- [ ] `score` 변수는 게임 시작 시 `0`으로 초기화
- [ ] 게임 종료 시 `await addGamePoints(score, 'gameId')` 호출
- [ ] 이전 버튼 클릭 시에도 점수 저장
- [ ] Game Over 화면에 "이번판 점수"와 "통합 포인트" 둘 다 표시
- [ ] `updatePointsDisplay()` 함수로 메뉴/게임오버 화면 포인트 업데이트
- [ ] `handleGameExit(event)` 함수 구현
- [ ] `.back-btn-game` 스타일 추가
- [ ] Material Icons 폰트 로드
- [ ] `confirm()` 메시지로 사용자 확인

---

## 8. 예시 코드 (최소 템플릿)

### HTML
```html
<div id="gameContainer" class="game-container hidden">
    <div class="stats">
        <a href="#" class="back-btn-game" onclick="handleGameExit(event)">
            <span class="material-icons">arrow_back</span>
        </a>
        <div class="stat-item">
            <div class="stat-label">Score</div>
            <div class="stat-value" id="score">0</div>
        </div>
        <!-- 기타 stat-item -->
    </div>
    <canvas id="gameCanvas"></canvas>
</div>
```

### JavaScript
```javascript
let score = 0;

async function startGame() {
    score = 0; // 항상 0부터 시작
    // 게임 초기화
}

async function endGame() {
    await addGamePoints(score, 'gameId');
    const totalPoints = getCurrentPoints();

    document.getElementById('finalScore').textContent = score.toLocaleString();
    document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
    // 게임 오버 화면 표시
}

async function handleGameExit(event) {
    event.preventDefault();
    if (gameState === 'playing' && confirm('게임을 종료하시겠습니까?\n현재 점수가 통합 포인트에 저장됩니다.')) {
        await addGamePoints(score, 'gameId');
        updatePointsDisplay();
        // 메뉴로 돌아가기
    }
}
```

---

## 9. 게임별 커스터마이징

각 게임의 테마에 맞게 색상과 스타일을 조정하세요:

### 색상 변수
```css
/* 스타워즈 X-Wing: 노란색/파란색 */
.back-btn-game { color: #ffcc00; }
.stat-label { color: #ffcc00; }
border-bottom: 2px solid rgba(255, 204, 0, 0.5);

/* 대포 디펜더: 보라색/초록색 */
.back-btn-game { color: #a855f7; }
.stat-label { color: #4CAF50; }
border-bottom: 2px solid rgba(168, 85, 247, 0.5);

/* 갤럭시 워: 파란색/흰색 */
.back-btn-game { color: #4488ff; }
.stat-label { color: #4488ff; }
border-bottom: 2px solid rgba(68, 136, 255, 0.5);
```

### 통계 항목 조정
게임에 따라 필요한 통계 항목을 추가/제거:
- Score (점수)
- Shields/HP (체력)
- Kills (처치)
- Level (레벨)
- Wave (웨이브)
- Combo (콤보)

---

## 10. 주요 차이점 정리

### ❌ 잘못된 방법
```javascript
// 게임 시작 시 통합 포인트를 초기 점수로 사용
const pointsResult = await usePointsForGameStart();
score = pointsResult.startingScore; // 통합 포인트 = 게임 점수 (혼동됨)
```

### ✅ 올바른 방법
```javascript
// 게임 시작 시 항상 0부터
score = 0; // 이번 판 점수

// 게임 종료 시 통합 포인트에 추가
await addGamePoints(score, 'gameId'); // score를 통합 포인트에 더하기
const totalPoints = getCurrentPoints(); // 업데이트된 통합 포인트
```

---

## 11. 트러블슈팅

### 문제: 포인트가 두 번 적립됨
**원인:** `endGame()`과 `handleGameExit()` 둘 다 호출
**해결:** `handleGameExit()`에서 `gameState` 체크

### 문제: 이전 버튼 클릭 시 점수가 저장 안 됨
**원인:** `event.preventDefault()` 빠짐
**해결:** 함수 시작에 `event.preventDefault()` 추가

### 문제: 통합 포인트가 표시 안 됨
**원인:** `getCurrentPoints()` 호출 안 함
**해결:** `endGame()`에서 `getCurrentPoints()` 호출 후 표시

---

이 가이드를 기준으로 모든 게임의 메인 헤더와 점수 시스템을 표준화하세요!
