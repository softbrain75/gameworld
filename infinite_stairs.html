<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>무한의 계단 ⬆️</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #B0E0E6);
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB, #B0E0E6);
            max-width: 100%;
            max-height: 100%;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .info {
            font-size: 1.1rem;
            margin: 0.5rem 0;
            text-align: center;
            padding: 0 2rem;
        }

        button {
            font-size: 1.5rem;
            padding: 1rem 3rem;
            margin: 1rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        .stats {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 3rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 5;
            font-weight: bold;
        }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            display: none;
            z-index: 5;
        }

        .controls.active {
            display: flex;
        }

        .control-btn {
            flex: 1;
            border: none;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn.left {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.6), rgba(41, 128, 185, 0.6));
        }

        .control-btn.right {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.6), rgba(192, 57, 43, 0.6));
        }

        .control-btn:active {
            opacity: 0.9;
        }

        .key-label {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .info { font-size: 1rem; }
            button { font-size: 1.2rem; padding: 0.8rem 2rem; }
            .stats { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="menuScreen" class="screen">
        <h1>⬆️ 무한의 계단</h1>
        <div class="info">계단을 타고 최대한 높이 올라가세요!</div>
        <div class="info">Z키: 앞으로 가기 / X키: 방향 전환</div>
        <div class="info">모바일: 왼쪽/오른쪽 버튼 터치</div>
        <div class="info" style="margin-top: 1rem;">최고 기록: <span id="menuHighScore">0</span>층</div>
        <button id="startBtn">게임 시작</button>
    </div>

    <div id="gameoverScreen" class="screen hidden">
        <h1>게임 오버</h1>
        <div class="info">도달 층수: <span id="finalScore">0</span>층</div>
        <div class="info">최고 기록: <span id="gameoverHighScore">0</span>층</div>
        <button id="retryBtn">다시 하기</button>
    </div>

    <div class="stats hidden" id="gameStats">
        <span id="floorCount">0</span>
    </div>

    <div class="controls" id="controls">
        <button class="control-btn left" id="leftBtn">
            <div>Z</div>
            <div class="key-label">앞으로</div>
        </button>
        <button class="control-btn right" id="rightBtn">
            <div>X</div>
            <div class="key-label">회전</div>
        </button>
    </div>

    <script>
        // Viewport height fix for mobile
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        window.addEventListener('resize', () => {
            vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Canvas setup
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        let gameState = 'menu';
        let highScore = parseInt(localStorage.getItem('infiniteStairs_highScore')) || 0;

        // Player
        const player = {
            x: 0,
            y: 0,
            size: 50,
            direction: 0, // 0: right, 1: up, 2: left, 3: down
            moving: false,
            moveProgress: 0,
            color: '#FF6B6B'
        };

        // Stairs
        let stairs = [];
        let currentStair = null;
        let nextStairDirection = null;
        let score = 0;
        let cameraOffset = 0;
        const stairSize = 80;

        // Input
        const keys = {};

        // Audio context
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playSound(type) {
            try {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(type) {
                    case 'step':
                        oscillator.frequency.value = 400 + Math.random() * 100;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'sine';
                        break;
                    case 'fall':
                        oscillator.frequency.value = 100;
                        gainNode.gain.value = 0.12;
                        oscillator.type = 'sine';
                        break;
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {}
        }

        // Initialize stairs
        function initStairs() {
            stairs = [];
            score = 0;

            // Starting position
            stairs.push({ x: 0, y: 0, direction: 0 });

            // Generate initial stairs
            let x = 0, y = 0;
            let direction = Math.random() > 0.5 ? 0 : 1; // 0: right, 1: forward

            for (let i = 0; i < 30; i++) {
                direction = Math.random() > 0.5 ? 0 : 1;

                if (direction === 0) { // right
                    x += stairSize;
                } else { // forward
                    y += stairSize;
                }

                stairs.push({ x, y, direction });
            }

            currentStair = stairs[0];
            nextStairDirection = stairs[1].x > stairs[0].x ? 0 : 1;

            player.x = 0;
            player.y = 0;
            player.direction = 0; // facing right initially
            player.moving = false;
            player.moveProgress = 0;
            cameraOffset = 0;
        }

        // Game loop
        function update() {
            if (gameState !== 'playing') return;

            // Input handling
            if ((keys['z'] || keys['Z']) && !player.moving) {
                moveForward();
            }
            if ((keys['x'] || keys['X']) && !player.moving) {
                turn();
            }

            // Moving animation
            if (player.moving) {
                player.moveProgress += 0.1;
                if (player.moveProgress >= 1) {
                    player.moving = false;
                    player.moveProgress = 0;

                    // Update player position
                    if (player.direction === 0) player.x += stairSize;
                    else if (player.direction === 1) player.y += stairSize;
                    else if (player.direction === 2) player.x -= stairSize;
                    else if (player.direction === 3) player.y -= stairSize;

                    // Check if on valid stair
                    const onStair = stairs.find(s => s.x === player.x && s.y === player.y);
                    if (!onStair) {
                        gameOver();
                        return;
                    }

                    currentStair = onStair;
                    score++;
                    document.getElementById('floorCount').textContent = score;
                    playSound('step');

                    // Generate new stair
                    const lastStair = stairs[stairs.length - 1];
                    const newDirection = Math.random() > 0.5 ? 0 : 1;
                    let newX = lastStair.x;
                    let newY = lastStair.y;

                    if (newDirection === 0) newX += stairSize;
                    else newY += stairSize;

                    stairs.push({ x: newX, y: newY, direction: newDirection });

                    // Remove old stairs
                    if (stairs.length > 50) {
                        stairs.shift();
                    }
                }
            }

            // Camera follows player
            const targetCameraX = player.x - canvas.width / 2;
            const targetCameraY = player.y - canvas.height / 2;
            cameraOffset = { x: targetCameraX, y: targetCameraY };
        }

        function moveForward() {
            player.moving = true;
            player.moveProgress = 0;
        }

        function turn() {
            player.direction = (player.direction + 1) % 4;
        }

        function draw() {
            // Clear with gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#B0E0E6');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraOffset.x, -cameraOffset.y);

            // Draw stairs
            stairs.forEach((stair, idx) => {
                const screenX = canvas.width / 2 + stair.x;
                const screenY = canvas.height / 2 + stair.y;

                // Stair top
                ctx.fillStyle = idx === 0 ? '#4CAF50' : '#8B4513';
                ctx.fillRect(screenX - stairSize/2, screenY - stairSize/2, stairSize, stairSize);

                // Stair outline
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 3;
                ctx.strokeRect(screenX - stairSize/2, screenY - stairSize/2, stairSize, stairSize);

                // Side walls for depth
                ctx.fillStyle = '#6B3410';
                ctx.fillRect(screenX - stairSize/2, screenY + stairSize/2, stairSize, 10);
            });

            // Draw player
            let drawX = canvas.width / 2 + player.x;
            let drawY = canvas.height / 2 + player.y;

            if (player.moving) {
                const moveX = player.direction === 0 ? stairSize : player.direction === 2 ? -stairSize : 0;
                const moveY = player.direction === 1 ? stairSize : player.direction === 3 ? -stairSize : 0;
                drawX += moveX * player.moveProgress;
                drawY += moveY * player.moveProgress;
            }

            // Player body
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(drawX, drawY - 20, player.size / 2, 0, Math.PI * 2);
            ctx.fill();

            // Player outline
            ctx.strokeStyle = '#FF5252';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Direction indicator
            ctx.fillStyle = 'white';
            ctx.beginPath();
            const angle = player.direction * Math.PI / 2;
            const arrowDist = player.size / 2 + 5;
            ctx.arc(
                drawX + Math.cos(angle) * arrowDist,
                drawY - 20 + Math.sin(angle) * arrowDist,
                5, 0, Math.PI * 2
            );
            ctx.fill();

            ctx.restore();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameState = 'playing';
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('gameoverScreen').classList.add('hidden');
            document.getElementById('gameStats').classList.remove('hidden');
            document.getElementById('controls').classList.add('active');

            initStairs();
            initAudio();

            document.getElementById('floorCount').textContent = score;
        }

        function gameOver() {
            gameState = 'gameover';
            playSound('fall');
            document.getElementById('gameStats').classList.add('hidden');
            document.getElementById('controls').classList.remove('active');
            document.getElementById('gameoverScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = score;

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('infiniteStairs_highScore', highScore);
            }

            document.getElementById('gameoverHighScore').textContent = highScore;
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('retryBtn').addEventListener('click', startGame);

        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch controls
        document.getElementById('leftBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (!player.moving) moveForward();
        });

        document.getElementById('rightBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (!player.moving) turn();
        });

        // High score display
        document.getElementById('menuHighScore').textContent = highScore;
        document.getElementById('gameoverHighScore').textContent = highScore;

        // Start game loop
        gameLoop();
    </script>
</body>
</html>
