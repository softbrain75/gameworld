<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>무한의 계단 ⬆️</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(to bottom, #2c3e50, #34495e);
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #2c3e50, #34495e);
            max-width: 100%;
            max-height: 100%;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .info {
            font-size: 1.1rem;
            margin: 0.5rem 0;
            text-align: center;
            padding: 0 2rem;
        }

        button {
            font-size: 1.5rem;
            padding: 1rem 3rem;
            margin: 1rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        .stats {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 5;
            font-weight: bold;
        }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            display: none;
            z-index: 5;
        }

        .controls.active {
            display: flex;
        }

        .control-btn {
            flex: 1;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.1s;
        }

        .control-btn.left {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.5), rgba(41, 128, 185, 0.5));
        }

        .control-btn.right {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.5), rgba(192, 57, 43, 0.5));
        }

        .control-btn:active {
            opacity: 1;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .info { font-size: 1rem; }
            button { font-size: 1.2rem; padding: 0.8rem 2rem; }
            .stats { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="menuScreen" class="screen">
        <h1>⬆️ 무한의 계단</h1>
        <div class="info">좌우로 계단을 올라가세요!</div>
        <div class="info">너무 느리면 떨어집니다!</div>
        <div class="info">← → 또는 A D 키로 이동</div>
        <div class="info">모바일: 화면 터치</div>
        <div class="info" style="margin-top: 1rem;">최고 기록: <span id="menuHighScore">0</span>층</div>
        <button id="startBtn">게임 시작</button>
    </div>

    <div id="gameoverScreen" class="screen hidden">
        <h1>게임 오버</h1>
        <div class="info">도달 층수: <span id="finalScore">0</span>층</div>
        <div class="info">최고 기록: <span id="gameoverHighScore">0</span>층</div>
        <button id="retryBtn">다시 하기</button>
    </div>

    <div class="stats hidden" id="gameStats">
        <span id="floorCount">0</span>층
    </div>

    <div class="controls" id="controls">
        <button class="control-btn left" id="leftBtn">◀</button>
        <button class="control-btn right" id="rightBtn">▶</button>
    </div>

    <script>
        // Viewport height fix for mobile
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        window.addEventListener('resize', () => {
            vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Canvas setup
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        let gameState = 'menu';
        let highScore = parseInt(localStorage.getItem('infiniteStairs_highScore')) || 0;

        // Player
        const player = {
            x: 0,
            y: 0,
            size: 40,
            side: 'left', // 'left' or 'right'
            climbing: false,
            climbProgress: 0
        };

        // Game variables
        let stairs = [];
        let cameraY = 0;
        let floor = 0;
        let gameSpeed = 2;
        let fallSpeed = 1;
        const stairHeight = 60;
        const stairWidth = 200;

        // Input
        const keys = {};

        // Audio context
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playSound(type) {
            try {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(type) {
                    case 'step':
                        oscillator.frequency.value = 300 + Math.random() * 100;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'sine';
                        break;
                    case 'fall':
                        oscillator.frequency.value = 150;
                        gainNode.gain.value = 0.12;
                        oscillator.type = 'sine';
                        break;
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {}
        }

        // Initialize stairs
        function initStairs() {
            stairs = [];
            for (let i = 0; i < 20; i++) {
                stairs.push({
                    side: i === 0 ? 'left' : (Math.random() > 0.5 ? 'left' : 'right'),
                    y: i * stairHeight,
                    floor: i
                });
            }
        }

        // Game loop
        function update() {
            if (gameState !== 'playing') return;

            // Input handling
            if ((keys['ArrowLeft'] || keys['a']) && !player.climbing) {
                if (player.side === 'right') {
                    climbStair();
                }
            }
            if ((keys['ArrowRight'] || keys['d']) && !player.climbing) {
                if (player.side === 'left') {
                    climbStair();
                }
            }

            // Climbing animation
            if (player.climbing) {
                player.climbProgress += 0.15;
                if (player.climbProgress >= 1) {
                    player.climbing = false;
                    player.climbProgress = 0;
                    player.side = player.side === 'left' ? 'right' : 'left';
                    floor++;
                    document.getElementById('floorCount').textContent = floor;
                    playSound('step');

                    // Add new stair
                    const lastStair = stairs[stairs.length - 1];
                    stairs.push({
                        side: Math.random() > 0.5 ? 'left' : 'right',
                        y: lastStair.y + stairHeight,
                        floor: lastStair.floor + 1
                    });

                    // Increase game speed
                    gameSpeed = Math.min(5, 2 + floor * 0.02);
                }
            }

            // Camera follows player
            const targetCameraY = floor * stairHeight;
            cameraY += (targetCameraY - cameraY) * 0.1;

            // Screen rises (player falls)
            cameraY += fallSpeed + gameSpeed * 0.3;

            // Remove old stairs
            stairs = stairs.filter(s => s.y > cameraY - canvas.height);

            // Check if player fell
            const playerStairY = floor * stairHeight;
            if (cameraY - playerStairY > canvas.height * 0.5) {
                gameOver();
            }
        }

        function climbStair() {
            // Check if next stair is on the opposite side
            const nextStair = stairs.find(s => s.floor === floor + 1);
            if (nextStair && nextStair.side !== player.side) {
                player.climbing = true;
                player.climbProgress = 0;
            }
        }

        function draw() {
            // Clear
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#2c3e50');
            gradient.addColorStop(1, '#34495e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();

            // Draw stairs
            stairs.forEach(stair => {
                const screenY = canvas.height - (stair.y - cameraY);

                if (screenY > -100 && screenY < canvas.height + 100) {
                    const xPos = stair.side === 'left' ?
                        canvas.width / 2 - stairWidth :
                        canvas.width / 2;

                    // Stair
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(xPos, screenY, stairWidth, stairHeight);

                    // Stair outline
                    ctx.strokeStyle = '#7f8c8d';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(xPos, screenY, stairWidth, stairHeight);

                    // Floor number
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 20px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.fillText(stair.floor, xPos + stairWidth / 2, screenY + stairHeight / 2 + 7);
                }
            });

            // Draw player
            const playerStair = stairs.find(s => s.floor === floor);
            if (playerStair) {
                let playerScreenY = canvas.height - (playerStair.y - cameraY);
                let playerX = playerStair.side === 'left' ?
                    canvas.width / 2 - stairWidth / 2 :
                    canvas.width / 2 + stairWidth / 2;

                if (player.climbing) {
                    const nextStair = stairs.find(s => s.floor === floor + 1);
                    if (nextStair) {
                        const nextScreenY = canvas.height - (nextStair.y - cameraY);
                        const nextX = nextStair.side === 'left' ?
                            canvas.width / 2 - stairWidth / 2 :
                            canvas.width / 2 + stairWidth / 2;

                        playerScreenY = playerScreenY + (nextScreenY - playerScreenY) * player.climbProgress;
                        playerX = playerX + (nextX - playerX) * player.climbProgress;
                    }
                }

                // Player body
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(playerX, playerScreenY - 20, player.size / 2, 0, Math.PI * 2);
                ctx.fill();

                // Player outline
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            ctx.restore();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameState = 'playing';
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('gameoverScreen').classList.add('hidden');
            document.getElementById('gameStats').classList.remove('hidden');
            document.getElementById('controls').classList.add('active');

            // Reset
            player.side = 'left';
            player.climbing = false;
            player.climbProgress = 0;
            cameraY = 0;
            floor = 0;
            gameSpeed = 2;
            document.getElementById('floorCount').textContent = floor;

            initStairs();
            initAudio();
        }

        function gameOver() {
            gameState = 'gameover';
            playSound('fall');
            document.getElementById('gameStats').classList.add('hidden');
            document.getElementById('controls').classList.remove('active');
            document.getElementById('gameoverScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = floor;

            if (floor > highScore) {
                highScore = floor;
                localStorage.setItem('infiniteStairs_highScore', highScore);
            }

            document.getElementById('gameoverHighScore').textContent = highScore;
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('retryBtn').addEventListener('click', startGame);

        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch controls
        document.getElementById('leftBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (player.side === 'right' && !player.climbing) {
                climbStair();
            }
        });

        document.getElementById('rightBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (player.side === 'left' && !player.climbing) {
                climbStair();
            }
        });

        // High score display
        document.getElementById('menuHighScore').textContent = highScore;
        document.getElementById('gameoverHighScore').textContent = highScore;

        // Start game loop
        gameLoop();
    </script>
</body>
</html>
